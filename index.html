<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nusantara Game Hub v14.7 (Stability Fix)</title>
    
    <!-- LIBRARIES -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Bangers&display=swap');
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: #0f172a; 
            color: white; 
            overflow: hidden; 
            touch-action: pan-x pan-y;
            -webkit-tap-highlight-color: transparent;
        }
        
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .glass-dark { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.1); }
        
        /* SCROLL FIXES */
        .scroll-y { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* TIMELINE */
        .timeline-container { position: relative; border-left: 2px solid rgba(255,255,255,0.1); margin-left: 10px; padding-left: 20px; }
        .timeline-item { position: relative; margin-bottom: 20px; }
        .timeline-dot { position: absolute; left: -26px; top: 5px; width: 10px; height: 10px; background: #fbbf24; border-radius: 50%; box-shadow: 0 0 10px rgba(251,191,36,0.5); }
        .timeline-ver { font-size: 10px; color: #94a3b8; font-family: monospace; }
        .timeline-content { font-size: 12px; color: #cbd5e1; }

        /* --- CARD SCROLL SNAP --- */
        #my-hand-container {
            display: flex; overflow-x: auto;
            padding: 40px calc(50% - 35px) 20px calc(50% - 35px); 
            gap: 0px; scroll-behavior: smooth; align-items: flex-end; width: 100%; height: 100%;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory; 
        }
        #my-hand-container > div {
            margin-right: -20px; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), margin 0.3s;
            flex-shrink: 0; scroll-snap-align: center; scroll-snap-stop: always;
        }
        #my-hand-container > div:hover, #my-hand-container > div:active {
            transform: translateY(-25px) scale(1.15) rotate(0deg) !important;
            margin-right: 15px; margin-left: 15px; z-index: 100; box-shadow: 0 15px 30px rgba(0,0,0,0.6);
        }

        /* CARD STYLES */
        .uno-card {
            width: 70px; height: 105px;
            @media (max-width: 360px) { width: 60px; height: 90px; }
            border-radius: 10px; position: relative; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5), inset 0 0 0 2px white;
            cursor: pointer; user-select: none; display: flex; justify-content: center; align-items: center; background-color: #1e293b;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            transform-style: preserve-3d;
        }
        .uno-card::before { content: ''; position: absolute; width: 100%; height: 60%; background: rgba(255,255,255,0.15); transform: rotate(25deg) scale(1.5); opacity: 0.3; pointer-events: none; }
        
        .skin-war { border: 2px solid #ef4444; box-shadow: 0 0 15px rgba(239,68,68,0.4); }
        .skin-zen { border: 2px solid #86efac; border-radius: 20px; opacity: 0.95; }
        .skin-chaos { animation: glitch 2s infinite; border: 2px solid #d946ef; }
        .skin-gold { border: 2px solid #ffd700; background-image: linear-gradient(45deg, rgba(255,215,0,0.2) 25%, transparent 25%); }
        @keyframes glitch { 0% { transform: skew(0deg); } 20% { transform: skew(-2deg); } 40% { transform: skew(2deg); } 100% { transform: skew(0deg); } }

        .uno-card .card-oval { width: 80%; height: 75%; background: white; border-radius: 50% / 45%; transform: rotate(-10deg); display: flex; justify-content: center; align-items: center; box-shadow: 2px 4px 8px rgba(0,0,0,0.2); position: absolute; z-index: 1; backface-visibility: hidden; }
        .uno-card .big-symbol { font-family: 'Bangers', cursive; font-size: 32px; -webkit-text-stroke: 1px black; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.3)); z-index: 2; position: relative; }
        .uno-card .corner-val { position: absolute; font-family: 'Bangers', cursive; font-size: 12px; color: white; text-shadow: 1px 1px 0 #000; z-index: 2; padding: 4px; }
        .tl { top: 2px; left: 4px; }
        .br { bottom: 2px; right: 4px; transform: rotate(180deg); }

        .c-red { background: linear-gradient(135deg, #ff5252 0%, #b91c1c 100%); color: #b91c1c; }
        .c-blue { background: linear-gradient(135deg, #448aff 0%, #1565c0 100%); color: #1565c0; }
        .c-green { background: linear-gradient(135deg, #69f0ae 0%, #2e7d32 100%); color: #2e7d32; }
        .c-yellow { background: linear-gradient(135deg, #ffff00 0%, #fbc02d 100%); color: #f57f17; }
        .c-black { background: linear-gradient(135deg, #424242 0%, #000000 100%); color: black; border: 2px solid gold; }
        .c-orange { background: linear-gradient(135deg, #ffab40 0%, #e65100 100%); color: #e65100; }
        .c-teal { background: linear-gradient(135deg, #64ffda 0%, #00695c 100%); color: #00695c; }
        .c-purple { background: linear-gradient(135deg, #e040fb 0%, #7b1fa2 100%); color: #7b1fa2; }
        .c-pink { background: linear-gradient(135deg, #ff4081 0%, #c2185b 100%); color: #c2185b; }
        .c-back-light { background: repeating-linear-gradient(45deg, #ff0000, #ff0000 10px, #000 10px, #000 20px); display: flex; justify-content: center; align-items: center; }
        .c-back-light::after { content: 'UNO'; font-family: 'Bangers'; font-size: 20px; color: #ffeb3b; text-shadow: 2px 2px 0 #000; transform: rotate(-25deg); background: #d32f2f; padding: 2px 6px; border-radius: 50%; border: 2px solid white; }
        .c-back-dark { background: repeating-linear-gradient(45deg, #7b1fa2, #7b1fa2 10px, #000 10px, #000 20px); border-color: #e040fb; }

        .chess-sq { display: flex; justify-content: center; align-items: center; font-size: clamp(20px, 6vw, 32px); cursor: pointer; transition: background 0.1s; position: relative; }
        .chess-white { background-color: #ebecd0; color: black; }
        .chess-black { background-color: #779556; color: black; }
        .chess-selected { background-color: #bbcb2b !important; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .valid-move::after { content: ''; width: 14px; height: 14px; background: rgba(0,0,0,0.2); border-radius: 50%; }
        .valid-capture::after { content: ''; width: 24px; height: 24px; border: 4px solid rgba(0,0,0,0.2); border-radius: 50%; }
        .board-flipped { transform: rotate(180deg); }
        .board-flipped .chess-sq { transform: rotate(180deg); }

        .hidden { display: none !important; }
        .screen { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0) rotate(180deg); } 100% { transform: scale(1) rotate(0deg); } }
        
        .flip-transition { animation: flip-board 0.8s forwards; }
        @keyframes flip-board {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(90deg) scale(0.8); }
            100% { transform: rotateY(0deg) scale(1); }
        }

        select:disabled { opacity: 0.7; cursor: not-allowed; background-color: #1e293b; color: #94a3b8; border-color: #334155; }
    </style>
</head>
<body>

    <!-- HOME -->
    <section id="screen-home" class="screen items-center justify-center bg-[url('https://images.unsplash.com/photo-1529699211952-734e80c4d42b?q=80&w=1000&auto=format&fit=crop')] bg-cover bg-center z-50">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <div class="glass p-6 sm:p-8 rounded-3xl text-center w-[90%] max-w-md mx-4 animate__animated animate__zoomIn relative z-10 border-t border-white/20">
            <h1 class="text-4xl sm:text-5xl font-black mb-1 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 tracking-tighter drop-shadow-sm">NGH v14.7</h1>
            <button onclick="window.ui.showHistory()" class="text-xs text-slate-400 font-mono border border-slate-600 px-3 py-1 rounded-full hover:bg-white/10 transition mb-6">v14.7 â€¢ Stability Fix</button>
            
            <div class="mb-4 flex gap-2 bg-black/40 p-1 rounded-xl">
                <input type="text" id="input-name" placeholder="Nickname" class="flex-1 p-3 rounded-lg bg-transparent text-white text-center font-bold outline-none placeholder:text-slate-500 min-w-0">
                <button onclick="window.utils.randomName()" class="bg-white/10 px-4 rounded-lg text-yellow-400 hover:bg-white/20 transition"><i class="fa-solid fa-dice"></i></button>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="window.app.createRoom()" class="bg-gradient-to-r from-blue-600 to-blue-500 py-4 rounded-xl font-bold hover:scale-105 active:scale-95 transition shadow-lg shadow-blue-500/30 text-sm sm:text-base">BUAT ROOM</button>
                <button onclick="window.app.showJoinInput()" class="bg-gradient-to-r from-emerald-600 to-emerald-500 py-4 rounded-xl font-bold hover:scale-105 active:scale-95 transition shadow-lg shadow-emerald-500/30 text-sm sm:text-base">GABUNG</button>
            </div>
            
            <div id="join-area" class="mt-4 hidden animate__animated animate__fadeInUp">
                <input type="text" id="input-room-code" maxlength="4" placeholder="KODE ROOM" class="w-full p-4 rounded-xl bg-slate-900/80 text-center font-mono text-2xl tracking-[0.5em] uppercase border border-slate-600 outline-none focus:border-yellow-400 text-yellow-400">
                <button onclick="window.app.joinRoom()" class="w-full mt-3 bg-yellow-500 text-black py-3 rounded-xl font-black tracking-wide hover:bg-yellow-400 active:scale-95 transition">MASUK</button>
                <div id="connection-status" class="text-xs text-slate-400 mt-3 font-mono h-4"></div>
            </div>
        </div>
    </section>

    <!-- HISTORY MODAL -->
    <div id="modal-history" class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass p-6 rounded-3xl w-full max-w-sm max-h-[80vh] flex flex-col relative">
            <button onclick="document.getElementById('modal-history').classList.add('hidden')" class="absolute top-4 right-4 text-white/50 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-xl font-bold text-yellow-400 mb-4 border-b border-white/10 pb-2">Riwayat Update</h2>
            <div class="scroll-y flex-1 pr-2">
                <div class="timeline-container">
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-ver">v14.7 (Sekarang)</div>
                        <div class="timeline-content">Perbaikan Bug Kritis: TypeError saat inisialisasi deck dan pencegahan crash pada mode UNO War/Chaos.</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-ver">v14.6</div>
                        <div class="timeline-content">Fix Logika Flip: Kartu fisik 2 sisi dan animasi putar 3D.</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-ver">v14.5</div>
                        <div class="timeline-content">Card Snap Scroll & UI Focus.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOBBY -->
    <section id="screen-lobby" class="screen hidden bg-slate-900 z-40">
        <div class="p-4 flex justify-between items-center glass border-b border-white/5 bg-slate-900/80 shrink-0">
            <div>
                <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Room Code</div>
                <div id="lobby-id-disp" class="text-3xl font-mono text-yellow-400 font-black cursor-pointer active:opacity-50 transition" onclick="window.app.copyId()">----</div>
            </div>
            <button onclick="location.reload()" class="bg-red-500/10 text-red-400 px-4 py-2 rounded-lg text-xs font-bold border border-red-500/20 active:bg-red-500/30 transition">KELUAR</button>
        </div>
        
        <div class="flex-1 p-4 scroll-y w-full flex flex-col items-center gap-4 pb-safe">
            <div id="lobby-panel" class="w-full max-w-md bg-slate-800/50 backdrop-blur p-5 rounded-2xl hidden border border-white/5 shadow-xl relative overflow-hidden shrink-0">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-yellow-400 font-bold text-sm uppercase flex items-center gap-2"><i class="fa-solid fa-gamepad"></i> Pengaturan</div>
                    <div id="guest-lock-indicator" class="hidden text-[10px] bg-slate-700 px-2 py-1 rounded text-slate-300 flex items-center gap-1"><i class="fa-solid fa-lock"></i> HOST VIEW</div>
                </div>
                
                <div class="space-y-4 relative">
                    <div id="guest-overlay-blocker" class="hidden absolute inset-0 z-10 cursor-not-allowed"></div>

                    <div>
                        <label class="text-xs text-slate-400 font-bold block mb-1">Mode Game</label>
                        <select id="game-mode-select" onchange="window.app.syncLobbySettings()" class="w-full bg-slate-900 p-3 rounded-xl text-white border border-slate-700 text-sm outline-none shadow-inner">
                            <optgroup label="Kartu UNO (10 Mode)">
                                <option value="UNO_CLASSIC">1. Classic (Standar)</option>
                                <option value="UNO_FLIP">2. Flip (Dark Side Mode)</option>
                                <option value="UNO_NO_MERCY">3. No Mercy (Sadis +10)</option>
                                <option value="UNO_CHAOS">4. Chaos (Semua Wild)</option>
                                <option value="UNO_ZEN">5. Zen Garden (Angka Saja)</option>
                                <option value="UNO_WAR">6. Total War (Full Action)</option>
                                <option value="UNO_SPEED">7. Speed Run (Cepat)</option>
                                <option value="UNO_MARATHON">8. Marathon (Panjang)</option>
                                <option value="UNO_OPEN">9. Open Hand (Terbuka)</option>
                                <option value="UNO_GOLDEN">10. Golden Era (Visual)</option>
                            </optgroup>
                            <optgroup label="Catur (5 Mode)">
                                <option value="CHESS_STD">Standard Chess</option>
                                <option value="CHESS_ATOMIC">Atomic Chess (Ledakan)</option>
                                <option value="CHESS_KOTH">King of the Hill</option>
                                <option value="CHESS_3CHECK">3-Check</option>
                                <option value="CHESS_REVOLT">Peasant Revolt</option>
                                <option value="CHESS_UPSIDE">Upside Down</option>
                            </optgroup>
                        </select>
                    </div>

                    <div id="uno-options">
                         <div class="text-[10px] text-slate-500 italic mb-2 leading-tight" id="mode-desc">Deskripsi mode.</div>
                         <label class="text-xs text-slate-400 font-bold block mb-1">Jml Kartu (4-15)</label>
                         <select id="initial-card-count" onchange="window.app.syncLobbySettings()" class="w-full bg-slate-900 p-3 rounded-xl text-white border border-slate-700 text-sm outline-none shadow-inner">
                             <option value="4">4 Kartu (Kilat)</option>
                             <option value="5">5 Kartu (Cepat)</option>
                             <option value="6">6 Kartu</option>
                             <option value="7" selected>7 Kartu (Normal)</option>
                             <option value="8">8 Kartu</option>
                             <option value="9">9 Kartu</option>
                             <option value="10">10 Kartu</option>
                             <option value="11">11 Kartu</option>
                             <option value="12">12 Kartu</option>
                             <option value="13">13 Kartu</option>
                             <option value="14">14 Kartu</option>
                             <option value="15">15 Kartu (Lama)</option>
                         </select>
                    </div>

                    <div id="chess-options" class="hidden">
                        <label class="text-xs text-slate-400 font-bold block mb-1">Warna Host</label>
                        <select id="chess-color-pref" onchange="window.app.syncLobbySettings()" class="w-full bg-slate-900 p-3 rounded-xl text-white border border-slate-700 text-sm outline-none">
                            <option value="white">Putih (Jalan Duluan)</option>
                            <option value="black">Hitam</option>
                            <option value="random">Acak</option>
                        </select>
                    </div>
                </div>

                <div class="mt-6 border-t border-white/5 pt-4">
                    <button id="btn-start-game" onclick="window.app.prepareGame()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 py-3 rounded-xl font-bold text-white shadow-lg active:scale-95 transition hidden">MULAI GAME</button>
                    <div id="guest-actions" class="hidden">
                        <div class="text-center mb-3 text-xs text-slate-400 animate-pulse">Menunggu Host...</div>
                        <button id="btn-vote-ready" onclick="window.app.toggleReady()" class="w-full bg-slate-700 py-3 rounded-xl font-bold border border-slate-600 hover:bg-green-600 active:scale-95 transition text-white shadow-lg">SIAP</button>
                    </div>
                </div>
            </div>

            <div class="w-full max-w-md shrink-0">
                <div class="flex justify-between items-end mb-2 pb-2 border-b border-white/10">
                    <h3 class="text-xs font-bold text-slate-400 uppercase">Pemain (<span id="player-count">0</span>)</h3>
                    <div class="text-xs text-green-400 font-mono bg-green-500/10 px-2 py-1 rounded"><span id="ready-count">0</span> SIAP</div>
                </div>
                <div id="lobby-list" class="space-y-2"></div>
            </div>
        </div>
    </section>

    <!-- LOADING -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-slate-900 hidden flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-bl
