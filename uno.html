<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nusantara Uno v2.0 (Dual Network)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="bot.js"></script>
    <script src="voice.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Titan+One&display=swap');
        body { font-family: 'Poppins', sans-serif; background: #0f172a; color: white; overflow: hidden; touch-action: none; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .font-titan { font-family: 'Titan One', cursive; }

        /* CARD STYLES */
        .card {
            width: 60px; height: 90px;
            background: white; border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s; cursor: pointer;
            border: 3px solid white;
        }
        .card:hover { transform: translateY(-10px) scale(1.1); z-index: 50; }
        .card-inner { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border-radius: 4px; position: relative; overflow: hidden; }
        .card-small { font-size: 8px; position: absolute; padding: 2px; }

        @media (min-width: 640px) {
            .card { width: 80px; height: 120px; border-width: 4px; border-radius: 8px; }
            .card-inner { font-size: 32px; }
            .card-small { font-size: 12px; }
        }
        .tl { top: 2px; left: 2px; }
        .br { bottom: 2px; right: 2px; transform: rotate(180deg); }

        /* COLORS */
        .c-red { background: #ef4444; color: white; }
        .c-blue { background: #3b82f6; color: white; }
        .c-green { background: #22c55e; color: white; }
        .c-yellow { background: #eab308; color: black; border-color: #fef08a !important; }
        .c-black { background: #1e293b; color: white; border: 2px solid white; }

        /* FLIP DARK SIDE COLORS */
        .c-orange { background: #f97316; color: white; }
        .c-teal { background: #14b8a6; color: white; }
        .c-purple { background: #a855f7; color: white; }
        .c-pink { background: #ec4899; color: white; }

        .center-deck { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 20px; }

        /* PLAYER ZONES */
        .zone { position: absolute; display: flex; align-items: center; justify-content: center; transition: all 0.5s; }
        .zone-bottom { bottom: 100px; left: 50%; transform: translateX(-50%); } /* ME - Moved up for music widget */
        .zone-top { top: 15px; left: 50%; transform: translateX(-50%) rotate(180deg); } /* P2 */
        .zone-left { left: 15px; top: 50%; transform: translateY(-50%) rotate(90deg); } /* P3 */
        .zone-right { right: 15px; top: 50%; transform: translateY(-50%) rotate(-90deg); } /* P4 */

        @media (min-width: 640px) {
            .zone-bottom { bottom: 40px; }
            .zone-top { top: 30px; }
            .zone-left { left: 40px; }
            .zone-right { right: 40px; }
        }

        .avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px; background: #334155; position: absolute; z-index: 10; transition: all 0.3s; }
        @media (min-width: 640px) { .avatar { width: 48px; height: 48px; font-size: 14px; } }
        .avatar.active { border-color: #eab308; box-shadow: 0 0 15px #eab308; transform: scale(1.1); }

        /* AUDIO PLAYER STYLES */
        #music-widget {
            position: fixed; bottom: 20px; right: 20px; z-index: 100; /* Lowered, but player hand moved up */
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 30px;
            padding: 8px 16px; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            max-width: 90%; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden; pointer-events: auto;
        }
        #music-widget.minimized {
            width: 50px; height: 50px; padding: 0; border-radius: 50%;
            justify-content: center; animation: spin 10s linear infinite;
            border: 2px solid #fbbf24; background: black;
        }
        #music-widget.minimized > *:not(.logo-icon) { display: none; }
        #music-widget .logo-icon { display: none; font-size: 24px; color: #fbbf24; }
        #music-widget.minimized .logo-icon { display: block; }
        #music-widget:hover { transform: scale(1.05); border-color: rgba(255,255,255,0.5); opacity: 1 !important; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .marquee { overflow: hidden; white-space: nowrap; max-width: 150px; font-size: 10px; color: #fbbf24; font-weight: bold; }
        .visualizer { display: flex; gap: 2px; height: 10px; align-items: flex-end; }
        .visualizer div { width: 3px; background: #fbbf24; animation: eq 0.5s infinite alternate; }
        .visualizer div:nth-child(2) { animation-delay: 0.1s; }
        .visualizer div:nth-child(3) { animation-delay: 0.2s; }
        @keyframes eq { 0% { height: 2px; } 100% { height: 100%; } }
    </style>
</head>
<body class="bg-[url('https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=1000&auto=format&fit=crop')] bg-cover">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>

    <!-- HOME -->
    <div id="screen-home" class="relative z-10 w-full h-screen flex flex-col items-center justify-center p-4">
        <h1 class="text-6xl font-titan text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-500 mb-2 drop-shadow-lg">UNO</h1>
        <div class="text-xl font-bold text-white mb-6 tracking-widest">NUSANTARA EDITION</div>

        <div class="glass p-6 rounded-2xl w-full max-w-md">
            <!-- MODE SELECT -->
             <div class="mb-4">
                <label class="text-xs text-slate-400 font-bold block mb-2">GAME MODE:</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="app.setGameMode('classic')" id="btn-mode-classic" class="bg-blue-600 p-2 rounded text-[10px] font-bold border border-white/20 hover:bg-blue-500">CLASSIC</button>
                    <button onclick="app.setGameMode('flip')" id="btn-mode-flip" class="bg-slate-700 p-2 rounded text-[10px] font-bold border border-white/20 hover:bg-slate-600">FLIP</button>
                    <button onclick="app.setGameMode('mercy')" id="btn-mode-mercy" class="bg-slate-700 p-2 rounded text-[10px] font-bold border border-white/20 hover:bg-slate-600">NO MERCY</button>
                    <button onclick="app.setGameMode('duel')" id="btn-mode-duel" class="bg-slate-700 p-2 rounded text-[10px] font-bold border border-white/20 hover:bg-slate-600">DUEL (2P)</button>
                    <button onclick="app.setGameMode('zen')" id="btn-mode-zen" class="bg-slate-700 p-2 rounded text-[10px] font-bold border border-white/20 hover:bg-slate-600">ZEN GARDEN</button>
                </div>
            </div>

            <!-- NETWORK SELECT -->
            <div class="bg-black/40 p-2 rounded-xl mb-4 flex justify-between items-center">
                <span class="text-[10px] text-slate-400 font-bold ml-2">NETWORK:</span>
                <div class="flex gap-1">
                    <button onclick="app.setNetworkMode('offline')" id="mode-offline" class="px-3 py-1 text-[10px] rounded bg-white/10 hover:bg-white/20">OFFLINE</button>
                    <button onclick="app.setNetworkMode('peerjs')" id="mode-online" class="px-3 py-1 text-[10px] rounded bg-yellow-500 text-black font-bold">ONLINE</button>
                </div>
            </div>

            <input type="text" id="input-name" placeholder="Nama Kamu" class="w-full bg-slate-800 p-3 rounded-lg text-center font-bold text-white mb-4 outline-none border border-slate-600 focus:border-red-500">

            <div id="controls-online" class="grid grid-cols-2 gap-3">
                <button onclick="app.createRoom()" class="bg-blue-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition">BUAT ROOM</button>
                <button onclick="app.joinRoomPrompt()" class="bg-green-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition">GABUNG</button>
            </div>
             <div id="controls-offline" class="hidden space-y-3">
                <select id="offline-player-count" class="w-full bg-slate-800 p-3 rounded-lg border border-slate-600">
                    <option value="2">2 Pemain</option>
                    <option value="3">3 Pemain</option>
                    <option value="4">4 Pemain</option>
                </select>
                <button onclick="app.createOfflineGame()" class="w-full bg-orange-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition">MULAI LOKAL / BOT</button>
            </div>

            <div id="join-input-area" class="hidden mt-4">
                 <input type="text" id="input-room" placeholder="KODE ROOM" class="w-full bg-slate-800 p-3 rounded-lg text-center font-mono uppercase text-xl mb-2 border border-slate-600 text-yellow-400">
                 <button onclick="app.joinRoom()" class="w-full bg-yellow-500 text-black py-2 rounded-lg font-bold">MASUK</button>
            </div>
        </div>
        <button onclick="window.parent.postMessage('EXIT_GAME', '*')" class="mt-8 text-slate-500 hover:text-white text-xs">KEMBALI KE MENU UTAMA</button>
    </div>

    <!-- GAME -->
    <div id="screen-game" class="hidden relative z-10 w-full h-screen overflow-hidden">
        <!-- TOP UI -->
        <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-start pointer-events-none">
            <div class="glass px-4 py-2 rounded-full pointer-events-auto flex gap-2 items-center">
                <button onclick="window.parent.postMessage('EXIT_GAME', '*')" class="mr-2 text-red-500 hover:text-white"><i class="fa-solid fa-arrow-left"></i></button>
                <span id="game-mode-display" class="text-xs font-black text-yellow-400 uppercase">CLASSIC</span>
                <div class="w-px h-3 bg-white/20"></div>
                <span id="room-display" class="text-[10px] text-slate-300 font-mono">ROOM: ...</span>
            </div>
            <div class="flex flex-col items-end pointer-events-auto gap-2">
                <button onclick="app.toggleVoice()" id="btn-mic" class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center text-slate-400 transition hover:bg-slate-600"><i class="fa-solid fa-microphone-slash text-xs"></i></button>
                <div id="voice-fx-panel" class="hidden bg-black/80 p-2 rounded flex-col gap-1">
                    <button onclick="window.voice.setEffect('robot', !window.voice.effects.robot); this.classList.toggle('text-green-400')" class="text-[10px] text-white">ðŸ¤– Robot</button>
                    <button onclick="window.voice.setEffect('echo', !window.voice.effects.echo); this.classList.toggle('text-green-400')" class="text-[10px] text-white">ðŸ”Š Echo</button>
                </div>
            </div>
        </div>

        <!-- CENTER AREA -->
        <div class="center-deck">
            <!-- DECK -->
            <div onclick="game.drawCard()" class="card bg-black border-4 border-white">
                <div class="card-inner bg-gradient-to-br from-slate-800 to-black text-white text-4xl flex items-center justify-center font-titan">UNO</div>
            </div>
            <!-- DISCARD -->
            <div id="discard-pile" class="relative w-[70px] h-[100px]"></div>
        </div>

        <!-- DIRECTION -->
        <div id="direction-indicator" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[300px] h-[300px] border-[20px] border-white/5 rounded-full pointer-events-none animate-spin-slow">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white/10 text-4xl"><i class="fa-solid fa-play"></i></div>
        </div>

        <!-- COLOR PICKER OVERLAY -->
        <div id="color-picker" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="game.pickColor('red')" class="w-24 h-24 bg-red-500 rounded-xl hover:scale-110 transition shadow-lg shadow-red-500/50"></button>
                <button onclick="game.pickColor('blue')" class="w-24 h-24 bg-blue-500 rounded-xl hover:scale-110 transition shadow-lg shadow-blue-500/50"></button>
                <button onclick="game.pickColor('green')" class="w-24 h-24 bg-green-500 rounded-xl hover:scale-110 transition shadow-lg shadow-green-500/50"></button>
                <button onclick="game.pickColor('yellow')" class="w-24 h-24 bg-yellow-400 rounded-xl hover:scale-110 transition shadow-lg shadow-yellow-400/50"></button>
            </div>
        </div>

        <!-- PLAYERS -->
        <div id="zones-container"></div>

        <!-- CURRENT TURN INDICATOR -->
        <div id="turn-alert" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-6xl font-black text-yellow-400 drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] animate-ping pointer-events-none">GILIRANMU!</div>
    </div>

    <!-- MUSIC WIDGET -->
    <div id="music-widget" class="interactive" onmouseenter="window.audio.resetTimer()" onmouseleave="window.audio.startTimer()" onclick="window.audio.resetTimer()">
        <i class="fa-solid fa-compact-disc logo-icon"></i>
        <div class="visualizer"><div></div><div></div><div></div></div>
        <div class="flex flex-col mr-2">
            <div id="music-title" class="marquee">Memuat Musik...</div>
            <div id="music-artist" class="text-[8px] text-slate-400">iTunes Radio</div>
        </div>
        <div class="flex gap-1">
             <button onclick="window.audio.prev()" class="text-slate-400 hover:text-white text-[10px] w-5 h-5 bg-white/5 rounded-full"><i class="fa-solid fa-backward-step"></i></button>
             <button onclick="window.audio.toggleMute()" id="btn-mute" class="text-slate-400 hover:text-white text-[10px] w-5 h-5 bg-white/5 rounded-full"><i class="fa-solid fa-volume-high"></i></button>
             <button onclick="window.audio.next()" class="text-slate-400 hover:text-white text-[10px] w-5 h-5 bg-white/5 rounded-full"><i class="fa-solid fa-forward-step"></i></button>
        </div>
        <button onclick="window.audio.openSearch()" class="text-slate-400 hover:text-yellow-400 text-xs ml-2"><i class="fa-solid fa-search"></i></button>
    </div>

     <!-- MUSIC SEARCH MODAL -->
    <div id="modal-music" class="fixed inset-0 z-[110] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass p-6 rounded-3xl w-full max-w-sm max-h-[80vh] flex flex-col relative">
            <button onclick="document.getElementById('modal-music').classList.add('hidden')" class="absolute top-4 right-4 text-white/50 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-xl font-bold text-yellow-400 mb-4 border-b border-white/10 pb-2">Cari Lagu</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="music-search-input" class="flex-1 bg-slate-800 rounded-lg px-3 py-2 text-xs text-white border border-slate-700 outline-none" placeholder="Judul lagu / Artis...">
                <button onclick="window.audio.search()" class="bg-blue-600 px-4 rounded-lg text-xs font-bold"><i class="fa-solid fa-search"></i></button>
            </div>
            <div id="music-results" class="flex-1 overflow-y-auto space-y-2 pr-1 text-xs"></div>
        </div>
    </div>

    <!-- WIN MODAL -->
    <div id="modal-win" class="hidden fixed inset-0 z-[100] bg-black/90 flex items-center justify-center">
        <div class="text-center animate-bounce">
            <h1 class="text-8xl mb-4">ðŸ‘‘</h1>
            <h2 class="text-4xl font-black text-yellow-400 mb-2">MENANG!</h2>
            <p id="winner-name" class="text-2xl text-white mb-8">Nama Player</p>
            <button onclick="location.reload()" class="bg-blue-600 px-8 py-3 rounded-full font-bold">MAIN LAGI</button>
        </div>
    </div>

    <script>
        const PEER_PREFIX = "NGH-UNO-V2-";

        // --- AUDIO MANAGER ---
        class AudioManager {
            constructor() {
                this.bgm = new Audio(); this.bgm.volume = 0.3; this.bgm.onended = () => this.handleTrackEnd();
                this.isMuted = false; this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.history = []; this.histIdx = -1;
                this.timer = null;
                this.playRandomIndo();
            }
            startTimer() { clearTimeout(this.timer); this.timer = setTimeout(() => document.getElementById('music-widget').classList.add('minimized'), 5000); }
            resetTimer() { clearTimeout(this.timer); document.getElementById('music-widget').classList.remove('minimized'); }

            playSfx(type) {
                if(this.isMuted) return; const o = this.ctx.createOscillator(); const g = this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination);
                if(type === 'draw') { o.frequency.value=600; g.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime+0.1); o.start(); o.stop(this.ctx.currentTime+0.1); }
                else if (type === 'play') { o.type='triangle'; o.frequency.value=400; g.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime+0.15); o.start(); o.stop(this.ctx.currentTime+0.15); }
                else if (type === 'uno') { o.type='sawtooth'; o.frequency.setValueAtTime(300, this.ctx.currentTime); o.frequency.linearRampToValueAtTime(600, this.ctx.currentTime+0.3); g.gain.linearRampToValueAtTime(0, this.ctx.currentTime+0.5); o.start(); o.stop(this.ctx.currentTime+0.5); }
            }
            playMusic(url, title, artist, addToHist=true) {
                this.bgm.src = url; this.bgm.play().catch(e => {});
                this.updateUI(title, artist); this.startTimer();
                if(addToHist && (this.history.length === 0 || this.history[this.history.length-1].url !== url)) { this.history.push({url, title, artist}); this.histIdx = this.history.length - 1; }
            }
            toggleMute() { this.isMuted = !this.isMuted; this.bgm.muted = this.isMuted; document.getElementById('btn-mute').innerHTML = this.isMuted ? '<i class="fa-solid fa-volume-xmark"></i>' : '<i class="fa-solid fa-volume-high"></i>'; }
            async playRandomIndo() { const terms = ['Indonesia Pop', 'Jazz Indonesia', 'Indo Hits']; const term = terms[Math.floor(Math.random()*terms.length)]; this.fetchAndPlay(term, true); }
            async fetchAndPlay(term, random=false) { try { const offset = random ? Math.floor(Math.random() * 50) : 0; const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&limit=1&offset=${offset}&media=music&country=ID`); const data = await res.json(); if(data.results[0]) this.syncAndPlay(data.results[0].previewUrl, data.results[0].trackName, data.results[0].artistName); } catch(e) {} }
            syncAndPlay(url, title, artist) { if(state.myIndex === 0) app.send({type: 'MUSIC_SYNC', url, title, artist}); this.playMusic(url, title, artist); }
            handleTrackEnd() { if(state.myIndex === 0) this.next(); }
            next() { if(state.myIndex !== 0) return; if(this.histIdx < this.history.length - 1) { this.histIdx++; const t = this.history[this.histIdx]; this.syncAndPlay(t.url, t.title, t.artist); } else { this.playRandomIndo(); } }
            prev() { if(state.myIndex !== 0) return; if(this.histIdx > 0) { this.histIdx--; const t = this.history[this.histIdx]; this.syncAndPlay(t.url, t.title, t.artist); } }
            openSearch() { document.getElementById('modal-music').classList.remove('hidden'); }
            async search() { const q = document.getElementById('music-search-input').value; if(!q) return; const list = document.getElementById('music-results'); list.innerHTML = 'Searching...'; try { const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(q)}&limit=10&media=music&country=ID`); const data = await res.json(); list.innerHTML = ''; data.results.forEach(t => { const div = document.createElement('div'); div.className = "flex justify-between items-center bg-white/5 p-2 rounded hover:bg-white/10 cursor-pointer"; div.innerHTML = `<div class="truncate w-48"><div class="font-bold text-yellow-400">${t.trackName}</div><div class="text-[10px] text-slate-400">${t.artistName}</div></div><button class="text-xs bg-blue-600 px-2 py-1 rounded"><i class="fa-solid fa-play"></i></button>`; div.onclick = () => { if(state.myIndex === 0) this.syncAndPlay(t.previewUrl, t.trackName, t.artistName); else app.sendHost({type: 'REQ_MUSIC', url: t.previewUrl, title: t.trackName, artist: t.artistName}); document.getElementById('modal-music').classList.add('hidden'); }; list.appendChild(div); }); } catch(e) { list.innerHTML = 'Error.'; } }
            updateUI(t, a) { document.getElementById('music-title').innerText = t; document.getElementById('music-artist').innerText = a; }
        }

        // --- GAME LOGIC ---
        const state = {
            networkMode: 'peerjs',
            myIndex: -1,
            gameMode: 'classic',
            game: {
                cards: {}, // Map of ID -> { l: {color, val, type}, d: {color, val, type} }
                deck: [],
                discard: [],
                players: [], // { name, hand: [], type: 'human'/'bot' }
                turn: 0,
                direction: 1,
                side: 'light', // 'light' or 'dark' (Flip mode)
                currentColor: null // Override for Wild
            }
        };
        window.state = state; // Expose for Bot

        const CARD_COLORS = ['red', 'blue', 'green', 'yellow'];
        const DARK_COLORS = ['orange', 'teal', 'purple', 'pink'];

        const game = {
            genDeck: () => {
                let id = 0;
                const add = (l, d) => {
                    state.game.cards[id] = { l, d };
                    state.game.deck.push(id);
                    id++;
                };

                // CLASSIC DECK GENERATION (Simplified for brevity but covers logic)
                // Numbers 0-9, Skips, Reverse, Draw2, Wild, Wild4
                // For FLIP, we generate Dark side parallels

                const colors = CARD_COLORS;
                const dColors = DARK_COLORS;

                colors.forEach((c, idx) => {
                    const dc = dColors[idx]; // Corresponding dark color
                    // 0-9
                    for(let n=0; n<=9; n++) {
                         add({color: c, val: n, type: 'num'}, {color: dc, val: n, type: 'num'}); // 1x 0-9
                         if(n!==0) add({color: c, val: n, type: 'num'}, {color: dc, val: n, type: 'num'}); // 2nd copy 1-9
                    }
                    // Action
                    ['skip', 'reverse', 'draw2'].forEach(t => {
                         add({color: c, val: t.toUpperCase(), type: t}, {color: dc, val: t==='draw2'?'D5':'SK', type: t==='draw2'?'draw5':'skip_all'});
                         add({color: c, val: t.toUpperCase(), type: t}, {color: dc, val: t==='draw2'?'D5':'SK', type: t==='draw2'?'draw5':'skip_all'});
                    });
                });

                // Wilds
                for(let i=0; i<4; i++) {
                    add({color: 'black', val: 'W', type: 'wild'}, {color: 'black', val: 'W', type: 'wild'});
                    add({color: 'black', val: '+4', type: 'wild4'}, {color: 'black', val: 'D_COL', type: 'wild_draw_color'});
                }

                // FLIP CARD
                if(state.gameMode === 'flip') {
                    colors.forEach((c, idx) => {
                         const dc = dColors[idx];
                         add({color: c, val: 'FLIP', type: 'flip'}, {color: dc, val: 'FLIP', type: 'flip'});
                         add({color: c, val: 'FLIP', type: 'flip'}, {color: dc, val: 'FLIP', type: 'flip'});
                    });
                }

                // NO MERCY
                if(state.gameMode === 'mercy') {
                    for(let i=0; i<4; i++) {
                        add({color: 'black', val: '+6', type: 'wild6'}, {color: 'black', val: '+10', type: 'wild10'});
                        add({color: 'black', val: '+10', type: 'wild10'}, {color: 'black', val: '+6', type: 'wild6'});
                    }
                    // Add more skips/reverses to make it brutal
                    colors.forEach((c, idx) => {
                        const dc = dColors[idx];
                        add({color: c, val: 'SK', type: 'skip_all'}, {color: dc, val: 'SK', type: 'skip_all'});
                    });
                }

                // ZEN
                if(state.gameMode === 'zen') {
                   // Filter out aggressive cards from generated deck?
                   // Or simplified: Zen mode implies no winners, but here just keeps playing.
                   // We'll leave it as is, but maybe remove +4s if we wanted to be strict.
                   // Actually, Zen usually just means "relax", so standard deck is fine,
                   // but maybe we remove score keeping (which we don't have anyway).
                }

                // Shuffle
                state.game.deck.sort(() => Math.random() - 0.5);
            },
            deal: () => {
                state.game.players.forEach(p => {
                    p.hand = state.game.deck.splice(0, 7);
                });
                // Start Card
                let startId = state.game.deck.pop();
                // Ensure not wild for simplicity
                while(state.game.cards[startId].l.color === 'black') {
                    state.game.deck.unshift(startId);
                    startId = state.game.deck.pop();
                }
                state.game.discard.push(startId);
                state.game.currentColor = state.game.cards[startId].l.color;
            },
            drawCard: () => {
                if(state.game.turn !== state.myIndex) return;
                app.send({type: 'DRAW_REQ'});
            },
            playCard: (cid) => {
                if(state.game.turn !== state.myIndex) return;
                const c = state.game.side === 'light' ? state.game.cards[cid].l : state.game.cards[cid].d;

                // Check valid
                const topId = state.game.discard[state.game.discard.length-1];
                const top = state.game.side === 'light' ? state.game.cards[topId].l : state.game.cards[topId].d;
                const curCol = state.game.currentColor || top.color;

                let valid = false;
                if(c.color === 'black') valid = true;
                else if(c.color === curCol) valid = true;
                else if(c.val === top.val) valid = true;

                if(!valid) { alert("Kartu tidak valid!"); return; }

                if(c.color === 'black') {
                    // Show Picker
                    ui.showColorPicker(cid);
                } else {
                    app.send({type: 'PLAY', cid, col: c.color});
                }
            },
            pickColor: (col) => {
                document.getElementById('color-picker').classList.add('hidden');
                // Pending move
                if(ui.pendingCard) {
                    app.send({type: 'PLAY', cid: ui.pendingCard, col: col});
                    ui.pendingCard = null;
                }
            },
            // Bot Logic Wrapper
            checkBot: () => {
                const p = state.game.players[state.game.turn];
                if(state.networkMode === 'offline' && p.type === 'bot') {
                    setTimeout(() => {
                        const topId = state.game.discard[state.game.discard.length-1];
                        const top = state.game.side === 'light' ? state.game.cards[topId].l : state.game.cards[topId].d;
                        const move = BotAI.Uno.getMove(p.hand, top, state.game.currentColor, state.game.side);

                        if(move.act === 'DRAW') app.send({type: 'DRAW_REQ'});
                        else app.send({type: 'PLAY', cid: move.cid, col: move.col});
                    }, 1500);
                }
            }
        };

        const ui = {
            pendingCard: null,
            init: () => {
                // Clear
            },
            render: () => {
                const con = document.getElementById('zones-container');
                con.innerHTML = '';

                // Me
                const me = state.game.players[state.myIndex];
                ui.createZone(con, me, 'zone-bottom', true);

                // Opponents
                const others = [];
                for(let i=1; i<state.game.players.length; i++) {
                     others.push(state.game.players[(state.myIndex + i) % state.game.players.length]);
                }

                if(others.length >= 1) ui.createZone(con, others[0], 'zone-top', false); // P2
                if(others.length >= 2) ui.createZone(con, others[1], 'zone-left', false); // P3
                if(others.length >= 3) ui.createZone(con, others[2], 'zone-right', false); // P4

                // Discard
                const disEl = document.getElementById('discard-pile');
                disEl.innerHTML = '';
                if(state.game.discard.length > 0) {
                    const topId = state.game.discard[state.game.discard.length-1];
                    disEl.appendChild(ui.createCardEl(topId, true)); // FIX: Show Face Up
                }

                // Turn Indicator
                if(state.game.turn === state.myIndex) document.getElementById('turn-alert').classList.remove('hidden');
                else document.getElementById('turn-alert').classList.add('hidden');

                // Direction
                document.getElementById('direction-indicator').style.animationDirection = state.game.direction === 1 ? 'normal' : 'reverse';

                // Color override indicator
                if(state.game.currentColor) {
                    const map = {red:'bg-red-500', blue:'bg-blue-500', green:'bg-green-500', yellow:'bg-yellow-400', orange:'bg-orange-500', teal:'bg-teal-500', purple:'bg-purple-500', pink:'bg-pink-500'};
                    disEl.style.boxShadow = `0 0 50px ${state.game.currentColor}`;
                }
            },
            createZone: (parent, p, cls, isMe) => {
                const z = document.createElement('div');
                z.className = `zone ${cls}`;

                // Avatar
                const av = document.createElement('div');
                av.className = `avatar ${state.game.players[state.game.turn] === p ? 'active' : ''}`;
                av.innerText = p.name.substring(0,2).toUpperCase();

                // Avatar Position Logic
                if (cls === 'zone-bottom') av.style.bottom = '110%';
                else if (cls === 'zone-top') av.style.bottom = '-60%';
                else if (cls.includes('left')) av.style.right = '-60%';
                else if (cls.includes('right')) av.style.left = '-60%';

                z.appendChild(av);

                // Hand Container to manage width
                const handCon = document.createElement('div');
                handCon.className = 'flex items-center justify-center';

                p.hand.forEach((cid, i) => {
                    const cEl = ui.createCardEl(cid, isMe);

                    // Dynamic Overlap Calculation
                    // If many cards, overlap more.
                    const overlap = p.hand.length > 7 ? -40 : -30;
                    const mobileOverlap = p.hand.length > 5 ? -35 : -25;
                    const isMobile = window.innerWidth < 640;
                    const finalOverlap = isMobile ? mobileOverlap : overlap;

                    if(!isMe) {
                        // Backside
                        cEl.innerHTML = '<div class="w-full h-full bg-black rounded border-2 border-white flex items-center justify-center"><div class="text-red-500 font-titan text-[10px] sm:text-xl">UNO</div></div>';
                        cEl.style.marginLeft = i===0 ? '0' : (finalOverlap + 'px');
                    } else {
                        cEl.style.marginLeft = i===0 ? '0' : (finalOverlap + 'px');
                        cEl.onclick = () => game.playCard(cid);
                        // Elevate on hover (handled by CSS, but ensure Z-index works with overlap)
                        cEl.style.zIndex = i;
                    }
                    handCon.appendChild(cEl);
                });

                z.appendChild(handCon);
                parent.appendChild(z);
            },
            createCardEl: (cid, faceUp) => {
                const div = document.createElement('div');
                div.className = 'card';
                if(!faceUp) return div; // Handled by caller for back

                const data = state.game.side === 'light' ? state.game.cards[cid].l : state.game.cards[cid].d;

                let bg = '';
                if(data.color === 'red') bg = 'c-red';
                else if(data.color === 'blue') bg = 'c-blue';
                else if(data.color === 'green') bg = 'c-green';
                else if(data.color === 'yellow') bg = 'c-yellow';
                else if(data.color === 'black') bg = 'c-black';
                // Dark
                else if(data.color === 'orange') bg = 'c-orange';
                else if(data.color === 'teal') bg = 'c-teal';
                else if(data.color === 'purple') bg = 'c-purple';
                else if(data.color === 'pink') bg = 'c-pink';

                div.classList.add(...bg.split(' ')); // Add classes

                let content = data.val;
                if(data.type.includes('wild')) content = '<i class="fa-solid fa-bahai fa-spin"></i>';
                if(data.type === 'skip') content = '<i class="fa-solid fa-ban"></i>';
                if(data.type === 'reverse') content = '<i class="fa-solid fa-arrows-rotate"></i>';

                div.innerHTML = `
                    <div class="card-small tl">${content}</div>
                    <div class="card-inner">${content}</div>
                    <div class="card-small br">${content}</div>
                `;
                return div;
            },
            showColorPicker: (cid) => {
                ui.pendingCard = cid;
                document.getElementById('color-picker').classList.remove('hidden');
            },
            toggleChat: () => { alert("Chat fitur segera hadir!"); }
        };

        const app = {
            setGameMode: (m) => {
                state.gameMode = m;
                document.querySelectorAll('[id^="btn-mode-"]').forEach(b => {
                    if(b.id === `btn-mode-${m}`) { b.classList.remove('bg-slate-700'); b.classList.add('bg-blue-600'); }
                    else { b.classList.add('bg-slate-700'); b.classList.remove('bg-blue-600'); }
                });
            },
            setNetworkMode: (m) => {
                state.networkMode = m;
                 if(m==='offline') {
                    document.getElementById('controls-online').classList.add('hidden');
                    document.getElementById('controls-offline').classList.remove('hidden');
                } else {
                    document.getElementById('controls-online').classList.remove('hidden');
                    document.getElementById('controls-offline').classList.add('hidden');
                }
            },
            createOfflineGame: () => {
                state.myIndex = 0;
                const count = parseInt(document.getElementById('offline-player-count').value);
                const players = [{name: 'YOU', hand:[], type: 'human'}];
                for(let i=1; i<count; i++) players.push({name: `BOT ${i}`, hand:[], type: 'bot'});

                app.startGame(players);
            },
            createRoom: () => {
                state.myIndex = 0;
                app.startGame([{name: document.getElementById('input-name').value || 'HOST', hand: [], type: 'human'}]);
                if(state.networkMode === 'peerjs') initPeerJS(PEER_PREFIX + Math.floor(Math.random()*9000));
            },
            joinRoomPrompt: () => { document.getElementById('join-input-area').classList.remove('hidden'); },
            joinRoom: () => {
                 state.myIndex = 1; // Basic assumption for demo
                 const code = document.getElementById('input-room').value;
                 app.startGame([]); // Empty players, will sync
                 if(state.networkMode === 'peerjs') initPeerJS(null, PEER_PREFIX + code);
            },
            startGame: (players) => {
                state.game.players = players;
                document.getElementById('screen-home').classList.add('hidden');
                document.getElementById('screen-game').classList.remove('hidden');
                document.getElementById('game-mode-display').innerText = state.gameMode;

                if(state.myIndex === 0) {
                    game.genDeck();
                    game.deal();
                    ui.render();
                }
            },
            send: (d) => {
                if(state.networkMode === 'offline') { app.handleData(d); return; }
                if(state.myIndex === 0) {
                    app.handleData(d); // Process Host
                    app.broadcast(d);
                } else {
                    if(peerInstance && peerInstance.conn) peerInstance.conn.send(d);
                }
            },
            broadcast: (d) => {
                if(peerInstance) Object.values(connections).forEach(c => c.send(d));
            },
            handleData: (d) => {
                if(d.type === 'DRAW_REQ') {
                    if(state.myIndex === 0) { // Host Logic
                        const p = state.game.players[state.game.turn];
                        const cid = state.game.deck.pop();
                        p.hand.push(cid);
                        // Reset wild color if drawn? No Uno rules say keep previous color.
                        app.broadcast({type: 'STATE', game: state.game});

                        // Pass turn if drawn? Uno rules vary. Usually play if playable.
                        // Simplified: Auto pass turn after draw.
                        state.game.turn = (state.game.turn + state.game.direction + state.game.players.length) % state.game.players.length;
                        app.broadcast({type: 'STATE', game: state.game});
                        ui.render();
                        game.checkBot();
                    }
                }
                else if (d.type === 'PLAY') {
                    if(state.myIndex === 0) {
                         const p = state.game.players[state.game.turn];
                         // Remove from hand
                         const idx = p.hand.indexOf(d.cid);
                         if(idx > -1) p.hand.splice(idx, 1);

                         state.game.discard.push(d.cid);
                         state.game.currentColor = d.col; // Set color (either card color or wild pick)

                         const cData = state.game.side === 'light' ? state.game.cards[d.cid].l : state.game.cards[d.cid].d;

                         // Special Actions
                         if(cData.type === 'reverse') state.game.direction *= -1;
                         if(cData.type === 'skip') state.game.turn = (state.game.turn + state.game.direction + state.game.players.length) % state.game.players.length;
                         if(cData.type === 'draw2') {
                             const nextP = state.game.players[(state.game.turn + state.game.direction + state.game.players.length) % state.game.players.length];
                             for(let k=0; k<2; k++) nextP.hand.push(state.game.deck.pop());
                             state.game.turn = (state.game.turn + state.game.direction + state.game.players.length) % state.game.players.length;
                         }
                         if(cData.type === 'wild6') {
                             const nextP = state.game.players[(state.game.turn + state.game.direction + state.game.players.length) % state.game.players.length];
                             for(let k=0; k<6; k++) nextP.hand.push(state.game.deck.pop());
                             state.game.turn = (state.game.turn + state.game.direction + state.game.players.length) % state.game.players.length;
                         }
                         if(cData.type === 'wild10') {
                             const nextP = state.game.players[(state.game.turn + state.game.direction + state.game.players.length) % state.game.players.length];
                             for(let k=0; k<10; k++) nextP.hand.push(state.game.deck.pop());
                             state.game.turn = (state.game.turn + state.game.direction + state.game.players.length) % state.game.players.length;
                         }
                         if(cData.type === 'flip') {
                             state.game.side = state.game.side === 'light' ? 'dark' : 'light';
                         }

                         // Next Turn
                         state.game.turn = (state.game.turn + state.game.direction + state.game.players.length) % state.game.players.length;

                         // Win Check
                         if(p.hand.length === 0) {
                             app.broadcast({type: 'WIN', name: p.name});
                         }

                         app.broadcast({type: 'STATE', game: state.game});
                         ui.render();
                         window.audio.playSfx('play');
                         game.checkBot();
                    }
                }
                else if (d.type === 'STATE') {
                    state.game = d.game;
                    ui.render();
                }
                else if (d.type === 'WIN') {
                    document.getElementById('winner-name').innerText = d.name;
                    document.getElementById('modal-win').classList.remove('hidden');
                }
                else if (d.type === 'MUSIC_SYNC') {
                    window.audio.playMusic(d.url, d.title, d.artist);
                }
            }
        };

        // --- PEERJS ---
        let peerInstance = null;
        let connections = {};
        const initPeerJS = (id, target) => {
            const peer = new Peer(id, { config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } });
            peerInstance = peer;
            peer.on('open', (pid) => {
                if(id) { // Host
                    document.getElementById('room-display').innerText = "ROOM: " + pid.replace(PEER_PREFIX, '');
                } else { // Client
                    const conn = peer.connect(target);
                    peer.conn = conn;
                    conn.on('open', () => {
                         conn.send({type: 'JOIN', name: document.getElementById('input-name').value});
                         document.getElementById('room-display').innerText = "ROOM: " + target.replace(PEER_PREFIX, '');
                    });
                    conn.on('data', d => {
                        if(d.type === 'STATE') {
                            state.game = d.game;
                            // Find my index
                            // This assumes players list is synced.
                            // In real app, sync ID/Session. Simplified here.
                            state.myIndex = state.game.players.findIndex(p => p.type === 'human' && p.hand.length === 0);
                            // Actually, finding "Me" in array is tricky without IDs.
                            // We'll rely on Host assigning index or simple order.
                            if(state.myIndex === -1) state.myIndex = state.game.players.length - 1;
                            ui.render();
                        } else app.handleData(d);
                    });
                }
            });
            peer.on('connection', (c) => {
                c.on('data', (d) => {
                    if(d.type === 'JOIN') {
                         state.game.players.push({name: d.name, hand: [], type: 'human'});
                         // Deal cards to new player
                         state.game.players[state.game.players.length-1].hand = state.game.deck.splice(0,7);

                         c.send({type: 'STATE', game: state.game});
                         ui.render();
                    } else {
                        app.handleData(d);
                    }
                });
                connections[c.peer] = c;
            });
        };

        window.audio = new AudioManager();
        window.voice = new VoiceManager();

        // Add to App
        app.toggleVoice = async () => {
             const btn = document.getElementById('btn-mic');
             const fx = document.getElementById('voice-fx-panel');
             if(btn.classList.contains('bg-red-500')) {
                 // Stop
                 window.voice.stop();
                 btn.classList.remove('bg-red-500', 'text-white');
                 btn.classList.add('bg-slate-700', 'text-slate-400');
                 btn.innerHTML = '<i class="fa-solid fa-microphone-slash text-xs"></i>';
                 fx.classList.add('hidden');
             } else {
                 // Start
                 const stream = await window.voice.getStream();
                 if(stream) {
                     btn.classList.add('bg-red-500', 'text-white');
                     btn.classList.remove('bg-slate-700', 'text-slate-400');
                     btn.innerHTML = '<i class="fa-solid fa-microphone text-xs"></i>';
                     fx.classList.remove('hidden');

                     // Connect to peers
                     if(peerInstance) {
                         if(state.myIndex === 0) Object.values(connections).forEach(c => peerInstance.call(c.peer, stream));
                         else if(peerInstance.conn) peerInstance.call(peerInstance.conn.peer, stream);
                     }
                 }
             }
        };

        window.app = app;
        window.game = game;
        window.ui = ui;
    </script>
</body>
</html>
