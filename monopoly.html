<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nusantara Monopoly v1.0</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Bangers&display=swap');
        body { font-family: 'Poppins', sans-serif; background: #0f172a; color: white; overflow: hidden; touch-action: none; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }

        /* MONOPOLY BOARD */
        .board-container {
            width: 100%; max-width: 600px; aspect-ratio: 1;
            background: #cde6d0; border: 4px solid #333;
            display: grid; grid-template-columns: 1.5fr repeat(9, 1fr) 1.5fr; grid-template-rows: 1.5fr repeat(9, 1fr) 1.5fr;
            position: relative; font-size: 8px; color: black;
        }
        .space { border: 1px solid #333; position: relative; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; background: #e0e0e0; }
        .space-color { width: 100%; height: 20%; border-bottom: 1px solid #333; }
        .space-name { padding: 2px; font-weight: bold; flex: 1; display: flex; align-items: center; justify-content: center; }
        .space-price { padding-bottom: 2px; font-size: 7px; }
        .corner { background: #bfdbfe; }

        .center-area { grid-column: 2 / 11; grid-row: 2 / 11; background: #0f172a; border: 1px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }

        /* TOKENS */
        .token {
            width: 15px; height: 15px; border-radius: 50%;
            border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            position: absolute; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50; pointer-events: none;
        }

        /* UTILS */
        .hidden { display: none !important; }
        .active-turn { box-shadow: 0 0 15px #fbbf24; border-color: #fbbf24; }

        /* AUDIO PLAYER STYLES */
        #music-widget {
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 30px;
            padding: 8px 16px; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            max-width: 90%; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        #music-widget.minimized {
            width: 50px; height: 50px; padding: 0; border-radius: 50%;
            justify-content: center; animation: spin 10s linear infinite;
            border: 2px solid #fbbf24; background: black;
        }
        #music-widget.minimized > *:not(.logo-icon) { display: none; }
        #music-widget .logo-icon { display: none; font-size: 24px; color: #fbbf24; }
        #music-widget.minimized .logo-icon { display: block; }
        #music-widget:hover { transform: scale(1.05); border-color: rgba(255,255,255,0.5); opacity: 1 !important; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .marquee { overflow: hidden; white-space: nowrap; max-width: 150px; font-size: 10px; color: #fbbf24; font-weight: bold; }
        .visualizer { display: flex; gap: 2px; height: 10px; align-items: flex-end; }
        .visualizer div { width: 3px; background: #fbbf24; animation: eq 0.5s infinite alternate; }
        .visualizer div:nth-child(2) { animation-delay: 0.1s; }
        .visualizer div:nth-child(3) { animation-delay: 0.2s; }
        @keyframes eq { 0% { height: 2px; } 100% { height: 100%; } }

        .toggle-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 4px 12px; border-radius: 8px; font-size: 10px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .toggle-btn.active { background: #eab308; color: black; border-color: #eab308; }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen w-screen bg-[url('https://images.unsplash.com/photo-1614294148960-9aa740632a87?q=80&w=1000&auto=format&fit=crop')] bg-cover">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>

    <!-- HOME SCREEN -->
    <div id="screen-home" class="relative z-10 text-center w-full max-w-md p-6">
        <h1 class="text-5xl font-black text-green-400 mb-2 drop-shadow-lg" style="font-family: 'Bangers'">MONOPOLY</h1>
        <p class="text-slate-300 mb-4">Multiplayer</p>

        <div class="glass p-6 rounded-2xl mb-4 text-left">
            <div class="bg-black/40 p-2 rounded-xl mb-4 flex justify-between items-center">
                <span class="text-[10px] text-slate-400 font-bold ml-2">NETWORK:</span>
                <div class="flex gap-1">
                    <button id="mode-simple" onclick="app.setNetworkMode('simple')" class="toggle-btn">SIMPLE PEER</button>
                    <button id="mode-peerjs" onclick="app.setNetworkMode('peerjs')" class="toggle-btn active">PEER JS</button>
                </div>
            </div>

            <input type="text" id="input-name" placeholder="Nama Kamu" class="w-full bg-slate-800 p-3 rounded-lg text-center font-bold text-white mb-4 outline-none border border-slate-600 focus:border-green-400">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="window.audio.playSfx('click'); app.createRoom()" class="bg-blue-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition">BUAT ROOM</button>
                <button onclick="window.audio.playSfx('click'); app.joinRoomPrompt()" class="bg-green-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition">GABUNG</button>
            </div>
            <div id="join-input-area" class="hidden mt-4">
                <div id="join-peerjs-input">
                    <input type="text" id="input-room" placeholder="Kode Room" class="w-full bg-slate-800 p-3 rounded-lg text-center font-mono uppercase text-xl mb-2 border border-slate-600">
                    <button onclick="window.audio.playSfx('click'); app.joinRoom()" class="w-full bg-yellow-500 text-black py-2 rounded-lg font-bold">MASUK</button>
                </div>
                <div id="join-simple-input" class="hidden">
                    <p class="text-[10px] text-slate-400 mb-2">Manual Signaling Mode</p>
                    <button onclick="window.audio.playSfx('click'); app.joinRoom()" class="w-full bg-yellow-500 text-black py-3 rounded-lg font-bold">START SIGNALING</button>
                </div>
            </div>
        </div>
        <button onclick="window.location.href='index.html'" class="text-xs text-slate-500 hover:text-white transition">KEMBALI KE MENU UTAMA</button>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="w-full h-full hidden flex flex-col items-center p-2 relative z-10">
        <div class="w-full max-w-[600px] flex justify-between items-center mb-2 text-xs">
            <div id="room-code" class="font-mono text-yellow-400 font-bold">ID: --</div>
            <div id="turn-indicator" class="bg-slate-700 px-3 py-1 rounded-full font-bold">Menunggu...</div>
        </div>

        <div class="board-container relative shadow-2xl" id="board">
            <div class="center-area">
                <h2 class="text-4xl font-black text-white/20 -rotate-45 select-none">MONOPOLY</h2>
                <div class="flex gap-4 mt-4 mb-4">
                    <div id="d1" class="w-10 h-10 bg-white text-black text-2xl font-bold flex items-center justify-center rounded">1</div>
                    <div id="d2" class="w-10 h-10 bg-white text-black text-2xl font-bold flex items-center justify-center rounded">1</div>
                </div>
                <button id="btn-roll" onclick="game.roll()" class="bg-yellow-500 text-black px-8 py-3 rounded-full font-black shadow-lg active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed transition hover:scale-105">LEMPAR DADU</button>
            </div>
        </div>

        <!-- PLAYER STATS -->
        <div id="player-stats" class="w-full max-w-[600px] flex gap-2 mt-4 overflow-x-auto"></div>
    </div>

    <!-- ACTION MODAL -->
    <div id="modal-action" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-2xl w-full max-w-sm text-center border border-white/10 shadow-2xl transform transition-all scale-100">
            <h3 id="modal-title" class="text-xl font-bold text-yellow-400 mb-2">Tanah Dijual</h3>
            <p id="modal-desc" class="text-sm text-slate-300 mb-4">Harga: $200</p>
            <div class="grid grid-cols-2 gap-3" id="modal-btns"></div>
        </div>
    </div>

    <!-- MUSIC WIDGET -->
    <div id="music-widget" class="animate__animated animate__fadeInUp" onmouseenter="window.audio.resetTimer()" onmouseleave="window.audio.startTimer()" onclick="window.audio.resetTimer()">
        <i class="fa-solid fa-compact-disc logo-icon"></i>
        <div class="visualizer"><div></div><div></div><div></div></div>
        <div class="flex flex-col mr-2">
            <div id="music-title" class="marquee">Memuat Musik...</div>
            <div id="music-artist" class="text-[8px] text-slate-400">iTunes Radio</div>
        </div>
        <div class="flex gap-1">
             <button onclick="window.audio.prev()" class="text-slate-400 hover:text-white text-[10px] w-5 h-5 bg-white/5 rounded-full"><i class="fa-solid fa-backward-step"></i></button>
             <button onclick="window.audio.toggleMute()" id="btn-mute" class="text-slate-400 hover:text-white text-[10px] w-5 h-5 bg-white/5 rounded-full"><i class="fa-solid fa-volume-high"></i></button>
             <button onclick="window.audio.next()" class="text-slate-400 hover:text-white text-[10px] w-5 h-5 bg-white/5 rounded-full"><i class="fa-solid fa-forward-step"></i></button>
        </div>
        <button onclick="window.audio.openSearch()" class="text-slate-400 hover:text-yellow-400 text-xs ml-2"><i class="fa-solid fa-search"></i></button>
    </div>

    <!-- VOICE BUTTON -->
    <button id="btn-mic" onclick="app.toggleVoice()" class="fixed bottom-5 left-5 z-[100] w-10 h-10 rounded-full bg-slate-800 border border-white/20 text-slate-400 shadow-xl flex items-center justify-center hover:bg-slate-700 active:scale-95 transition hidden animate__animated animate__fadeInLeft">
        <i class="fa-solid fa-microphone-slash"></i>
    </button>
    <div id="voice-streams" class="hidden"></div>

    <!-- MUSIC SEARCH MODAL -->
    <div id="modal-music" class="fixed inset-0 z-[110] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass p-6 rounded-3xl w-full max-w-sm max-h-[80vh] flex flex-col relative">
            <button onclick="document.getElementById('modal-music').classList.add('hidden')" class="absolute top-4 right-4 text-white/50 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-xl font-bold text-yellow-400 mb-4 border-b border-white/10 pb-2">Cari Lagu</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="music-search-input" class="flex-1 bg-slate-800 rounded-lg px-3 py-2 text-xs text-white border border-slate-700 outline-none" placeholder="Judul lagu / Artis...">
                <button onclick="window.audio.search()" class="bg-blue-600 px-4 rounded-lg text-xs font-bold"><i class="fa-solid fa-search"></i></button>
            </div>
            <div id="music-results" class="flex-1 overflow-y-auto space-y-2 pr-1 text-xs"></div>
        </div>
    </div>

    <!-- MANUAL SIGNALING MODAL -->
    <div id="modal-signal" class="fixed inset-0 z-[120] bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass p-6 rounded-3xl w-full max-w-sm flex flex-col relative">
            <button onclick="document.getElementById('modal-signal').classList.add('hidden')" class="absolute top-4 right-4 text-white/50 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-xl font-bold text-yellow-400 mb-4 border-b border-white/10 pb-2">Manual Signaling</h2>
            <div id="signal-step-1">
                <p class="text-xs text-slate-300 mb-2">1. Salin kode ini & kirim ke teman:</p>
                <textarea id="my-signal-data" readonly class="w-full h-24 bg-slate-900 p-2 text-[10px] font-mono rounded border border-slate-700 text-green-400 break-all"></textarea>
                <button onclick="app.copySignal()" class="w-full mt-2 bg-blue-600 py-2 rounded text-xs font-bold mb-2">SALIN KODE SAYA</button>
                <button onclick="document.getElementById('signal-step-1').classList.add('hidden'); document.getElementById('signal-step-2').classList.remove('hidden');" class="w-full bg-slate-700 py-2 rounded text-xs font-bold mb-4 text-slate-300 border border-slate-600 hover:bg-slate-600">SAYA SUDAH KIRIM â†’</button>
            </div>
            <div id="signal-step-2">
                <p class="text-xs text-slate-300 mb-2">2. Tempel kode balasan dari teman:</p>
                <textarea id="other-signal-data" class="w-full h-24 bg-slate-900 p-2 text-[10px] font-mono rounded border border-slate-700 text-white break-all" placeholder="Paste kode teman disini..."></textarea>
                <button onclick="app.connectSignal()" class="w-full mt-2 bg-green-600 py-2 rounded text-xs font-bold">SAMBUNGKAN</button>
            </div>
        </div>
    </div>

    <script>
        const PEER_PREFIX = "NGH-MONO-V1-";

        // BOARD DATA
        const SPACES = [
            { name: "GO", type: "go" },
            { name: "Mediteran", type: "prop", price: 60, color: "brown", rent: 2 },
            { name: "Community", type: "card" },
            { name: "Baltic", type: "prop", price: 60, color: "brown", rent: 4 },
            { name: "Pajak", type: "tax", cost: 200 },
            { name: "Station 1", type: "station", price: 200 },
            { name: "Oriental", type: "prop", price: 100, color: "lightblue", rent: 6 },
            { name: "Chance", type: "card" },
            { name: "Vermont", type: "prop", price: 100, color: "lightblue", rent: 6 },
            { name: "Conn. Ave", type: "prop", price: 120, color: "lightblue", rent: 8 },
            { name: "JAIL", type: "jail" },
            { name: "Charles", type: "prop", price: 140, color: "pink", rent: 10 },
            { name: "Electric", type: "util", price: 150 },
            { name: "States", type: "prop", price: 140, color: "pink", rent: 10 },
            { name: "Virginia", type: "prop", price: 160, color: "pink", rent: 12 },
            { name: "Station 2", type: "station", price: 200 },
            { name: "James", type: "prop", price: 180, color: "orange", rent: 14 },
            { name: "Community", type: "card" },
            { name: "Tenn.", type: "prop", price: 180, color: "orange", rent: 14 },
            { name: "New York", type: "prop", price: 200, color: "orange", rent: 16 },
            { name: "PARKING", type: "parking" },
            { name: "Kentucky", type: "prop", price: 220, color: "red", rent: 18 },
            { name: "Chance", type: "card" },
            { name: "Indiana", type: "prop", price: 220, color: "red", rent: 18 },
            { name: "Illinois", type: "prop", price: 240, color: "red", rent: 20 },
            { name: "Station 3", type: "station", price: 200 },
            { name: "Atlantic", type: "prop", price: 260, color: "yellow", rent: 22 },
            { name: "Ventnor", type: "prop", price: 260, color: "yellow", rent: 22 },
            { name: "Water", type: "util", price: 150 },
            { name: "Marvin", type: "prop", price: 280, color: "yellow", rent: 24 },
            { name: "GOTO JAIL", type: "goto_jail" },
            { name: "Pacific", type: "prop", price: 300, color: "green", rent: 26 },
            { name: "Carolina", type: "prop", price: 300, color: "green", rent: 26 },
            { name: "Community", type: "card" },
            { name: "Penn", type: "prop", price: 320, color: "green", rent: 28 },
            { name: "Station 4", type: "station", price: 200 },
            { name: "Chance", type: "card" },
            { name: "Park Pl", type: "prop", price: 350, color: "blue", rent: 35 },
            { name: "Luxury", type: "tax", cost: 100 },
            { name: "Boardwalk", type: "prop", price: 400, color: "blue", rent: 50 }
        ];

        const COLORS = { brown: '#92400e', lightblue: '#bae6fd', pink: '#f9a8d4', orange: '#fb923c', red: '#ef4444', yellow: '#fde047', green: '#22c55e', blue: '#3b82f6' };

        const state = {
            myIndex: -1, roomCode: '', networkMode: 'peerjs',
            game: { players: [], turn: 0, active: false }
        };

        // AUDIO SYSTEM (Standard)
        class AudioManager {
            constructor() {
                this.bgm = new Audio(); this.bgm.volume = 0.3; this.bgm.onended = () => this.handleTrackEnd();
                this.isMuted = false; this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.history = []; this.histIdx = -1; this.timer = null;
                this.playRandomIndo();
            }
            startTimer() { clearTimeout(this.timer); this.timer = setTimeout(() => document.getElementById('music-widget').classList.add('minimized'), 5000); }
            resetTimer() { clearTimeout(this.timer); document.getElementById('music-widget').classList.remove('minimized'); }
            playSfx(type) {
                if(this.isMuted) return; const o = this.ctx.createOscillator(); const g = this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination);
                if(type === 'click') { o.type = 'sine'; o.frequency.value = 800; g.gain.setValueAtTime(0.1, this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime + 0.1); o.start(); o.stop(this.ctx.currentTime + 0.1); }
            }
            playMusic(url, title, artist, addToHist=true) {
                this.bgm.src = url; this.bgm.play().catch(e => console.log("Autoplay blocked", e));
                this.updateUI(title, artist); this.startTimer();
                if(addToHist) {
                    if(this.history.length === 0 || this.history[this.history.length-1].url !== url) {
                         this.history.push({url, title, artist});
                         this.histIdx = this.history.length - 1;
                    }
                }
            }
            toggleMute() { this.isMuted = !this.isMuted; this.bgm.muted = this.isMuted; document.getElementById('btn-mute').innerHTML = this.isMuted ? '<i class="fa-solid fa-volume-xmark"></i>' : '<i class="fa-solid fa-volume-high"></i>'; document.querySelector('.visualizer').style.opacity = this.isMuted ? 0 : 1; }
            async playRandomIndo() { const terms = ['Indonesia Pop', 'Lagu Indonesia']; const term = terms[Math.floor(Math.random()*terms.length)]; this.fetchAndPlay(term, true); }
            async fetchAndPlay(term, random=false) { try { const offset = random ? Math.floor(Math.random() * 50) : 0; const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&limit=1&offset=${offset}&media=music&country=ID`); const data = await res.json(); if(data.results && data.results.length > 0) { const track = data.results[0]; this.syncAndPlay(track.previewUrl, track.trackName, track.artistName); } } catch(e) {} }
            syncAndPlay(url, title, artist) { if(state.myIndex === 0) app.send({type: 'MUSIC_SYNC', url, title, artist}); this.playMusic(url, title, artist); }
            handleTrackEnd() { if(state.myIndex === 0) this.next(); }
            next() { if(state.myIndex !== 0) return; if(this.histIdx < this.history.length - 1) { this.histIdx++; const t = this.history[this.histIdx]; this.syncAndPlay(t.url, t.title, t.artist); } else { this.playRandomIndo(); } }
            prev() { if(state.myIndex !== 0) return; if(this.histIdx > 0) { this.histIdx--; const t = this.history[this.histIdx]; this.syncAndPlay(t.url, t.title, t.artist); } }
            openSearch() { document.getElementById('modal-music').classList.remove('hidden'); }
            async search() { const q = document.getElementById('music-search-input').value; if(!q) return; const list = document.getElementById('music-results'); list.innerHTML = '<div class="text-center animate-pulse">Mencari...</div>'; try { const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(q)}&limit=10&media=music&country=ID`); const data = await res.json(); list.innerHTML = ''; data.results.forEach(t => { const div = document.createElement('div'); div.className = "flex justify-between items-center bg-white/5 p-2 rounded hover:bg-white/10 cursor-pointer"; div.innerHTML = `<div class="truncate w-48"><div class="font-bold text-yellow-400">${t.trackName}</div><div class="text-[10px] text-slate-400">${t.artistName}</div></div><button class="text-xs bg-blue-600 px-2 py-1 rounded"><i class="fa-solid fa-play"></i></button>`; div.onclick = () => { if(state.myIndex === 0) { this.syncAndPlay(t.previewUrl, t.trackName, t.artistName); } else { app.sendHost({type: 'REQ_MUSIC', url: t.previewUrl, title: t.trackName, artist: t.artistName}); alert("Request dikirim ke Host"); } document.getElementById('modal-music').classList.add('hidden'); }; list.appendChild(div); }); } catch(e) { list.innerHTML = 'Error.'; } }
            updateUI(t, a) { document.getElementById('music-title').innerText = t; document.getElementById('music-artist').innerText = a; }
        }

        const utils = {
            randId: () => Math.floor(1000 + Math.random() * 9000).toString(),
            sleep: (ms) => new Promise(r => setTimeout(r, ms))
        };

        const ui = {
            initBoard: () => {
                const b = document.getElementById('board');
                SPACES.forEach((s, i) => {
                    const el = document.createElement('div');
                    el.className = 'space';
                    if(i===0) { el.style.gridArea = '11 / 11 / 12 / 12'; el.classList.add('corner'); }
                    else if(i<10) { el.style.gridArea = `11 / ${11-i} / 12 / ${12-i}`; }
                    else if(i===10) { el.style.gridArea = '11 / 1 / 12 / 2'; el.classList.add('corner'); }
                    else if(i<20) { el.style.gridArea = `${21-i} / 1 / ${22-i} / 2`; }
                    else if(i===20) { el.style.gridArea = '1 / 1 / 2 / 2'; el.classList.add('corner'); }
                    else if(i<30) { el.style.gridArea = `1 / ${i-19} / 2 / ${i-18}`; }
                    else if(i===30) { el.style.gridArea = '1 / 11 / 2 / 12'; el.classList.add('corner'); }
                    else { el.style.gridArea = `${i-29} / 11 / ${i-28} / 12`; }

                    el.innerHTML = `<div class="space-name" style="font-size:${s.name.length>8?'6px':'8px'}">${s.name}</div>`;
                    if(s.type === 'prop' || s.type === 'station' || s.type === 'util') {
                        const col = document.createElement('div');
                        col.className = 'space-color';
                        if(s.color) col.style.backgroundColor = COLORS[s.color];
                        else col.style.backgroundColor = '#64748b'; // Station/Util color

                        if(i<10 || i>30) el.prepend(col); else el.appendChild(col);
                        el.innerHTML += `<div class="space-price">$${s.price}</div>`;
                    }
                    el.id = `space-${i}`;
                    b.appendChild(el);
                });
            },
            renderPlayers: () => {
                document.querySelectorAll('.token').forEach(t => t.remove());
                const pColors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308'];

                state.game.players.forEach((p, idx) => {
                    const t = document.createElement('div');
                    t.className = 'token';
                    t.style.backgroundColor = pColors[idx % 4];
                    const space = document.getElementById(`space-${p.pos}`);
                    if(space) {
                        const rect = space.getBoundingClientRect();
                        const bRect = document.getElementById('board').getBoundingClientRect();
                        const offX = (idx % 2) * 5;
                        const offY = (idx > 1) * 5;
                        t.style.left = (rect.left - bRect.left + 5 + offX) + 'px';
                        t.style.top = (rect.top - bRect.top + 5 + offY) + 'px';
                        document.getElementById('board').appendChild(t);
                    }

                    const st = document.getElementById(`pstat-${idx}`);
                    if(st) {
                        st.innerHTML = `<div class="w-2 h-2 rounded-full inline-block" style="background:${pColors[idx%4]}"></div> <b>${p.name}</b><br>$${p.money}`;
                        st.className = `bg-slate-800 p-2 rounded text-[10px] border flex-shrink-0 ${state.game.turn === idx ? 'active-turn' : 'border-white/10'}`;
                    }
                });
            },
            updateTurn: () => {
                const turnName = state.game.players[state.game.turn].name;
                const isMe = state.game.turn === state.myIndex;
                document.getElementById('turn-indicator').innerText = isMe ? "GILIRAN KAMU" : `Giliran ${turnName}`;
                document.getElementById('btn-roll').disabled = !isMe;
                document.getElementById('btn-roll').classList.toggle('opacity-50', !isMe);
            },
            showModal: (title, desc, actions) => {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-desc').innerText = desc;
                const c = document.getElementById('modal-btns'); c.innerHTML = '';
                actions.forEach(a => {
                    const b = document.createElement('button');
                    b.className = `py-2 rounded font-bold ${a.cls}`;
                    b.innerText = a.text;
                    b.onclick = () => { document.getElementById('modal-action').classList.add('hidden'); a.cb(); };
                    c.appendChild(b);
                });
                document.getElementById('modal-action').classList.remove('hidden');
            }
        };

        const game = {
            init: () => {
                ui.initBoard();
                document.getElementById('player-stats').innerHTML = '';
                state.game.players.forEach((p,i) => {
                    const d = document.createElement('div'); d.id=`pstat-${i}`;
                    document.getElementById('player-stats').appendChild(d);
                });
                ui.renderPlayers();
                ui.updateTurn();
            },
            roll: () => {
                if(state.game.turn !== state.myIndex) return;
                const d1 = Math.floor(Math.random()*6)+1;
                const d2 = Math.floor(Math.random()*6)+1;
                app.send({type:'ROLL', d1, d2});
            },
            handleRoll: (d1, d2) => {
                document.getElementById('d1').innerText = d1;
                document.getElementById('d2').innerText = d2;
                const p = state.game.players[state.game.turn];
                p.pos = (p.pos + d1 + d2) % 40;
                ui.renderPlayers();
                // Logic land (only current turn player computes, others wait for sync/action)
                // Actually, logic active on all clients? No, logic active on turn player, then they broadcast result.
                // Better: Logic active on turn player, sends action (Buy/Pay) to others.
                if(state.game.turn === state.myIndex) setTimeout(() => game.land(p), 1000);
            },
            land: (p) => {
                const s = SPACES[p.pos];
                if(s.type === 'prop' || s.type === 'station' || s.type === 'util') {
                    if(s.owner === undefined) {
                        if(p.money >= s.price) {
                            ui.showModal(s.name, `Harga: $${s.price}. Beli?`, [
                                {text: "BELI", cls: "bg-green-600 text-white", cb: () => app.send({type:'BUY', idx: p.pos})},
                                {text: "LEWATI", cls: "bg-slate-600 text-white", cb: () => app.send({type:'END_TURN'})}
                            ]);
                        } else {
                            app.send({type:'END_TURN'}); // Auto skip if no money
                        }
                    } else if (s.owner !== state.myIndex) {
                        const rent = s.rent || 20;
                        app.send({type:'PAY', amount: rent, to: s.owner});
                    } else {
                        app.send({type:'END_TURN'});
                    }
                } else if (s.type === 'tax') {
                    app.send({type:'PAY', amount: s.cost, to: 'bank'});
                } else if (s.type === 'goto_jail') {
                    app.send({type:'JAIL'});
                } else {
                    app.send({type:'END_TURN'});
                }
            },
            buy: (pid, idx) => {
                const p = state.game.players[pid]; const s = SPACES[idx];
                if(p.money >= s.price && !s.owner) {
                    p.money -= s.price; s.owner = pid; p.props.push(idx);
                    document.getElementById(`space-${idx}`).style.borderColor = ['#ef4444','#3b82f6','#22c55e','#eab308'][pid%4];
                    document.getElementById(`space-${idx}`).style.borderWidth = '3px';
                }
                if(pid === state.game.turn) game.nextTurn();
            },
            pay: (fromPid, amount, toPid) => {
                const p = state.game.players[fromPid]; p.money -= amount;
                if(toPid !== 'bank') state.game.players[toPid].money += amount;
                if(fromPid === state.game.turn) game.nextTurn();
            },
            nextTurn: () => {
                state.game.turn = (state.game.turn + 1) % state.game.players.length;
                ui.updateTurn(); ui.renderPlayers();
            }
        };

        // NETWORK MANAGER (Standard)
        let peerInstance = null; let connections = {}; let simplePeer = null;
        const app = {
            init: () => { const u = new URL(window.location.href); const n = u.searchParams.get('name'); if(n) document.getElementById('input-name').value = n; },
            setNetworkMode: (mode) => {
                state.networkMode = mode;
                document.getElementById('mode-simple').classList.toggle('active', mode === 'simple');
                document.getElementById('mode-peerjs').classList.toggle('active', mode === 'peerjs');
                if(mode === 'peerjs') { document.getElementById('join-peerjs-input').classList.remove('hidden'); document.getElementById('join-simple-input').classList.add('hidden'); }
                else { document.getElementById('join-peerjs-input').classList.add('hidden'); document.getElementById('join-simple-input').classList.remove('hidden'); }
            },
            createRoom: () => {
                const name = document.getElementById('input-name').value || "Host";
                state.myIndex = 0; state.game.players = [{name, money:1500, pos:0, props:[], peerId: 'host'}];
                if(state.networkMode === 'peerjs') initPeerJS(PEER_PREFIX + utils.randId()); else initSimplePeerHost();
            },
            joinRoomPrompt: () => { document.getElementById('join-input-area').classList.remove('hidden'); app.setNetworkMode(state.networkMode); },
            joinRoom: () => {
                const name = document.getElementById('input-name').value || "Guest";
                if(state.networkMode === 'peerjs') { const c = document.getElementById('input-room').value.toUpperCase(); initPeerJS(null, c); }
                else initSimplePeerGuest();
            },
            send: (data) => {
                if(state.myIndex === 0) { app.handleData(data, {peer:'me'}); if(state.networkMode==='peerjs') Object.values(connections).forEach(c=>c.send(data)); else if(simplePeer) simplePeer.send(JSON.stringify(data)); }
                else app.sendHost(data);
            },
            sendHost: (data) => { if(state.networkMode==='peerjs') { if(connections['host']) connections['host'].send(data); } else if(simplePeer) simplePeer.send(JSON.stringify(data)); },
            handleData: (d, conn) => {
                if(state.myIndex === 0) { // HOST
                    if(d.type === 'JOIN') {
                        state.game.players.push({name: d.name, money:1500, pos:0, props:[], peerId: conn.peer||'guest'});
                        const update = {type:'STATE', game: state.game, myIdx: state.game.players.length-1};
                        if(state.networkMode==='peerjs') conn.send(update); else if(simplePeer) simplePeer.send(JSON.stringify(update));
                        const bc = {type:'STATE', game: state.game};
                        if(state.networkMode==='peerjs') Object.values(connections).forEach(c=>{if(c.peer!==conn.peer)c.send(bc)});
                        game.init();
                    }
                    else if(d.type === 'ROLL') { game.handleRoll(d.d1, d.d2); app.broadcastGame(); }
                    else if(d.type === 'BUY') { game.buy(state.game.turn, d.idx); app.broadcastGame(); }
                    else if(d.type === 'PAY') { game.pay(state.game.turn, d.amount, d.to); app.broadcastGame(); }
                    else if(d.type === 'END_TURN') { game.nextTurn(); app.broadcastGame(); }
                    else if(d.type === 'JAIL') { state.game.players[state.game.turn].pos=10; game.nextTurn(); app.broadcastGame(); }
                    else if(d.type === 'REQ_MUSIC') { app.send({type: 'MUSIC_SYNC', url: d.url, title: d.title, artist: d.artist}); window.audio.playMusic(d.url, d.title, d.artist); }
                } else { // GUEST
                    if(d.type === 'STATE') { state.game = d.game; if(d.myIdx!==undefined) state.myIndex=d.myIdx; document.getElementById('screen-home').classList.add('hidden'); document.getElementById('screen-game').classList.remove('hidden'); document.getElementById('room-code').innerText="Playing"; game.init(); }
                    else if(d.type === 'UPDATE_GAME') { state.game = d.game; ui.renderPlayers(); ui.updateTurn(); }
                    else if(d.type === 'MUSIC_SYNC') window.audio.playMusic(d.url, d.title, d.artist);
                }
            },
            broadcastGame: () => {
                const d = {type:'UPDATE_GAME', game: state.game};
                if(state.networkMode==='peerjs') Object.values(connections).forEach(c=>c.send(d)); else if(simplePeer) simplePeer.send(JSON.stringify(d));
            },
            copySignal: () => { document.getElementById('my-signal-data').select(); document.execCommand('copy'); alert("Copied!"); },
            connectSignal: () => { try { simplePeer.signal(JSON.parse(document.getElementById('other-signal-data').value)); document.getElementById('modal-signal').classList.add('hidden'); } catch(e){ alert("Invalid"); } },
            toggleVoice: async () => {
                const btn = document.getElementById('btn-mic');
                const isAct = btn.classList.contains('text-red-500');
                if(isAct) {
                    if(window.myStream) window.myStream.getTracks().forEach(t => t.stop());
                    window.myStream = null;
                    btn.classList.remove('text-red-500', 'border-red-500');
                    btn.classList.add('text-slate-400');
                    btn.innerHTML = '<i class="fa-solid fa-microphone-slash"></i>';
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                        window.myStream = stream;
                        btn.classList.add('text-red-500', 'border-red-500');
                        btn.classList.remove('text-slate-400');
                        btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';

                        if(state.networkMode === 'peerjs' && peerInstance) {
                             if(state.myIndex === 0) {
                                 Object.values(connections).forEach(c => peerInstance.call(c.peer, stream));
                             } else if(peerInstance.conn) {
                                 peerInstance.call(peerInstance.conn.peer, stream);
                             }
                        }
                    } catch(e) { alert("Gagal akses mic: " + e); }
                }
            },
            addAudioStream: (s) => { const a=document.createElement('audio'); a.srcObject=s; a.play(); document.getElementById('voice-streams').appendChild(a); }
        };

        // NETWORK IMPL (Simplified copies of Ludo)
        const initPeerJS = (id, targetId) => {
            const peer = new Peer(id, { config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } });
            peerInstance = peer;
            peer.on('call', c => { c.answer(); c.on('stream', s => app.addAudioStream(s)); });
            peer.on('open', pid => {
                if(state.myIndex===0) { state.roomCode = pid.replace(PEER_PREFIX,''); document.getElementById('room-code').innerText="ID: "+state.roomCode; document.getElementById('screen-home').classList.add('hidden'); document.getElementById('screen-game').classList.remove('hidden'); state.game.players[0].peerId=pid; game.init(); }
                else { const conn = peer.connect(PEER_PREFIX+targetId); peer.conn=conn; conn.on('open', ()=>conn.send({type:'JOIN', name:document.getElementById('input-name').value})); conn.on('data', d=>app.handleData(d,conn)); connections['host']=conn; }
            });
            peer.on('connection', c => { c.on('data', d=>app.handleData(d,c)); c.on('open', ()=>{connections[c.peer]=c; if(window.myStream) peer.call(c.peer, window.myStream);}); });
        };
        const initSimplePeerHost = () => { simplePeer = new SimplePeer({initiator:true, trickle:false}); setupSimplePeerEvents(simplePeer, true); };
        const initSimplePeerGuest = () => { simplePeer = new SimplePeer({initiator:false, trickle:false}); setupSimplePeerEvents(simplePeer, false); ui.showSignalModal("", 2); };
        const setupSimplePeerEvents = (p, isHost) => {
            p.on('signal', d => ui.showSignalModal(JSON.stringify(d), 1));
            p.on('connect', () => { document.getElementById('modal-signal').classList.add('hidden'); if(isHost) { document.getElementById('screen-home').classList.add('hidden'); document.getElementById('screen-game').classList.remove('hidden'); game.init(); } else p.send(JSON.stringify({type:'JOIN', name:document.getElementById('input-name').value})); });
            p.on('data', d => app.handleData(JSON.parse(d.toString()), {}));
        };

        window.audio = new AudioManager();
        app.init();

    </script>
</body>
</html>
